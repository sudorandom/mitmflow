edition = "2023";

package mitmflow.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";
import "mitmproxygrpc/v1/service.proto";

service Service {
  rpc GetFlows(GetFlowsRequest) returns (stream GetFlowsResponse) {}
  rpc StreamFlows(StreamFlowsRequest) returns (stream StreamFlowsResponse) {}
  rpc UpdateFlow(UpdateFlowRequest) returns (UpdateFlowResponse) {}
  rpc DeleteFlows(DeleteFlowsRequest) returns (DeleteFlowsResponse) {}
  rpc ExportFlows(ExportFlowsRequest) returns (ExportFlowsResponse) {}
  rpc GetFlow(GetFlowRequest) returns (GetFlowResponse) {}
}

message FlowFilter {
  string filter_text = 1 [features.field_presence = EXPLICIT];
  bool pinned = 2 [features.field_presence = EXPLICIT];
  bool has_note = 3 [features.field_presence = EXPLICIT];
  repeated string flow_types = 4 [(buf.validate.field).repeated.items.string = {
    in: [
      "http",
      "dns",
      "tcp",
      "udp"
    ]
  }];
  repeated string client_ips = 5 [(buf.validate.field).repeated.items.string.ip = true];
  HttpFilter http = 6;
  repeated string flow_ids = 7;
}

message HttpFilter {
  repeated string methods = 1 [(buf.validate.field).repeated.items.string = {
    pattern: "^[A-Z]+$"
    max_len: 20
  }];
  // e.g. "application/json", "text/html"
  repeated string content_types = 2;
  // e.g. "200", "4xx", "200-299"
  repeated string status_codes = 3;
}

message GetFlowRequest {
  string flow_id = 1;
}

message GetFlowResponse {
  Flow flow = 1;
}

message GetFlowsRequest {
  FlowFilter filter = 1;
  int32 limit = 2;
}

message GetFlowsResponse {
  FlowSummary flow = 1;
}

message StreamFlowsRequest {
  int64 since_timestamp_ns = 1;
  FlowFilter filter = 2;
}

message StreamFlowsResponse {
  oneof response {
    FlowSummary flow = 1;
  }
}

message UpdateFlowRequest {
  string flow_id = 1;
  bool pinned = 2 [features.field_presence = EXPLICIT];
  string note = 3 [features.field_presence = EXPLICIT];
}

message UpdateFlowResponse {
  FlowSummary flow = 1;
}

message DeleteFlowsRequest {
  repeated string flow_ids = 1;
  bool all = 2;
}

message DeleteFlowsResponse {
  int64 count = 1;
}

enum ExportFormat {
  EXPORT_FORMAT_UNSPECIFIED = 0;
  EXPORT_FORMAT_HAR = 1;
  EXPORT_FORMAT_JSON = 2;
}

message ExportFlowsRequest {
  repeated string flow_ids = 1;
  ExportFormat format = 2;
}

message ExportFlowsResponse {
  bytes data = 1;
  string filename = 2;
}

message FlowSummary {
  string id = 1;
  string type = 2; // "http", "dns", "tcp", "udp"
  google.protobuf.Timestamp timestamp_start = 3;
  bool pinned = 4;
  string note = 5;
  oneof summary {
    HttpFlowSummary http = 6;
    DnsFlowSummary dns = 7;
    TcpFlowSummary tcp = 8;
    UdpFlowSummary udp = 9;
  }
}

message HttpFlowSummary {
  string method = 1;
  string url = 2;
  int32 status_code = 3;
  int64 duration_ms = 4;
  int64 request_content_length = 5;
  int64 response_content_length = 6;
  string client_peername_host = 7;
  string server_address_host = 8;
  uint32 server_address_port = 9;
  uint32 client_peername_port = 10;
}

message DnsFlowSummary {
  string question_name = 1;
  string client_peername_host = 2;
  string error = 3;
}

message TcpFlowSummary {
  string server_address_host = 1;
  uint32 server_address_port = 2;
  string client_peername_host = 3;
  uint32 client_peername_port = 4;
  string error = 5;
}

message UdpFlowSummary {
  string server_address_host = 1;
  uint32 server_address_port = 2;
  string client_peername_host = 3;
  uint32 client_peername_port = 4;
  string error = 5;
}

message Flow {
  oneof flow {
    mitmproxy.v1.HTTPFlow http_flow = 1;
    mitmproxy.v1.TCPFlow tcp_flow = 2;
    mitmproxy.v1.UDPFlow udp_flow = 3;
    mitmproxy.v1.DNSFlow dns_flow = 4;
  }
  HTTPFlowExtra http_flow_extra = 5;
  bool pinned = 6;
  string note = 7;
}

message HTTPFlowExtra {
  MessageDetails request = 1;
  MessageDetails response = 2;
}

message MessageDetails {
  repeated string textual_frames = 1;
  string effective_content_type = 2;
  int64 body_size = 3;
}
