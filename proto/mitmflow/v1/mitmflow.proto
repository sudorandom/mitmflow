syntax = "proto3";

package mitmflow.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/sudorandom/mitmflow/gen/go/mitmflow/v1;mitmflowv1";

service Service {
  rpc ExportFlow(stream ExportFlowRequest) returns (ExportFlowResponse) {}
  rpc StreamFlows(StreamFlowsRequest) returns (stream StreamFlowsResponse) {}
}

enum EventType {
  EVENT_TYPE_UNSPECIFIED = 0;
  EVENT_TYPE_REQUESTHEADERS = 1;
  EVENT_TYPE_REQUEST = 2;
  EVENT_TYPE_RESPONSEHEADERS = 3;
  EVENT_TYPE_RESPONSE = 4;
  EVENT_TYPE_ERROR = 5;
  EVENT_TYPE_HTTP_CONNECT = 6;
  EVENT_TYPE_HTTP_CONNECT_UPSTREAM = 7;
  EVENT_TYPE_HTTP_CONNECTED = 8;
  EVENT_TYPE_HTTP_CONNECT_ERROR = 9;
  EVENT_TYPE_DNS_REQUEST = 10;
  EVENT_TYPE_DNS_RESPONSE = 11;
  EVENT_TYPE_DNS_ERROR = 12;
  EVENT_TYPE_TCP_START = 13;
  EVENT_TYPE_TCP_MESSAGE = 14;
  EVENT_TYPE_TCP_END = 15;
  EVENT_TYPE_TCP_ERROR = 16;
  EVENT_TYPE_UDP_START = 17;
  EVENT_TYPE_UDP_MESSAGE = 18;
  EVENT_TYPE_UDP_END = 19;
  EVENT_TYPE_UDP_ERROR = 20;
  EVENT_TYPE_QUIC_START_CLIENT = 21;
  EVENT_TYPE_QUIC_START_SERVER = 22;
  EVENT_TYPE_TLS_CLIENTHELLO = 23;
  EVENT_TYPE_TLS_START_CLIENT = 24;
  EVENT_TYPE_TLS_START_SERVER = 25;
  EVENT_TYPE_TLS_ESTABLISHED_CLIENT = 26;
  EVENT_TYPE_TLS_ESTABLISHED_SERVER = 27;
  EVENT_TYPE_TLS_FAILED_CLIENT = 28;
  EVENT_TYPE_TLS_FAILED_SERVER = 29;
  EVENT_TYPE_WEBSOCKET_START = 30;
  EVENT_TYPE_WEBSOCKET_MESSAGE = 31;
  EVENT_TYPE_WEBSOCKET_END = 32;
}

enum ConnectionState {
  CONNECTION_STATE_UNSPECIFIED = 0;
  CONNECTION_STATE_CLOSED = 1;
  CONNECTION_STATE_OPEN = 2;
  CONNECTION_STATE_ESTABLISHED = 3;
  CONNECTION_STATE_CAN_READ = 4;
  CONNECTION_STATE_CAN_WRITE = 5;
}

enum TransportProtocol {
  TRANSPORT_PROTOCOL_UNSPECIFIED = 0;
  TRANSPORT_PROTOCOL_TCP = 1;
  TRANSPORT_PROTOCOL_UDP = 2;
}

enum TLSVersion {
  TLS_VERSION_UNSPECIFIED = 0;
  TLS_VERSION_SSLV3 = 1;
  TLS_VERSION_TLSV1 = 2;
  TLS_VERSION_TLSV1_1 = 3;
  TLS_VERSION_TLSV1_2 = 4;
  TLS_VERSION_TLSV1_3 = 5;
  TLS_VERSION_DTLSV0_9 = 6;
  TLS_VERSION_DTLSV1 = 7;
  TLS_VERSION_DTLSV1_2 = 8;
  TLS_VERSION_QUICV1 = 9;
}

enum ViaProtocol {
  VIA_PROTOCOL_UNSPECIFIED = 0;
  VIA_PROTOCOL_HTTP = 1;
  VIA_PROTOCOL_HTTPS = 2;
  VIA_PROTOCOL_HTTP3 = 3;
  VIA_PROTOCOL_TLS = 4;
  VIA_PROTOCOL_DTLS = 5;
  VIA_PROTOCOL_TCP = 6;
  VIA_PROTOCOL_UDP = 7;
  VIA_PROTOCOL_DNS = 8;
  VIA_PROTOCOL_QUIC = 9;
}

message Cert {
  bytes content = 1;
  bytes fingerprint = 2;
  map<string, string> issuers = 3;
  google.protobuf.Timestamp notbefore = 4;
  google.protobuf.Timestamp notafter = 5;
  bool hasexpired = 6;
  map<string, string> subjects = 7;
  string serial = 8;
  bool is_ca = 9;
  map<string, int64> keyinfo = 10;
  optional string cn = 11;
  optional string organization = 12;
  repeated string altnames = 13;
  repeated string crl_distribution_points = 14;
}

message Via {
  ViaProtocol protocol = 1;
  string host = 2;
  uint32 port = 3;
}

message ClientConn {
  string peername_host = 1;
  uint32 peername_port = 2;
  string sockname_host = 3;
  uint32 sockname_port = 4;
  ConnectionState state = 5;
  string id = 6;
  TransportProtocol transport_protocol = 7;
  optional string error = 8;
  bool tls = 9;
  repeated Cert certificate_list = 10;
  optional bytes alpn = 11;
  repeated bytes alpn_offers = 12;
  optional string cipher = 13;
  repeated string cipher_list = 14;
  optional TLSVersion tls_version = 15;
  optional string sni = 16;
  google.protobuf.Timestamp timestamp_start = 17;
  optional google.protobuf.Timestamp timestamp_end = 18;
  optional google.protobuf.Timestamp timestamp_tls_setup = 19;
  optional Cert mitmcert = 20;
  string proxy_mode = 21;
}

message ServerConn {
  optional string peername_host = 1;
  optional uint32 peername_port = 2;
  optional string sockname_host = 3;
  optional uint32 sockname_port = 4;
  ConnectionState state = 5;
  string id = 6;
  TransportProtocol transport_protocol = 7;
  optional string error = 8;
  bool tls = 9;
  repeated Cert certificate_list = 10;
  optional bytes alpn = 11;
  repeated bytes alpn_offers = 12;
  optional string cipher = 13;
  repeated string cipher_list = 14;
  optional TLSVersion tls_version = 15;
  optional string sni = 16;
  optional google.protobuf.Timestamp timestamp_start = 17;
  optional google.protobuf.Timestamp timestamp_end = 18;
  optional google.protobuf.Timestamp timestamp_tls_setup = 19;
  optional string address_host = 20;
  optional uint32 address_port = 21;
  optional google.protobuf.Timestamp timestamp_tcp_setup = 22;
  optional Via via = 23;
}

message ExportFlowRequest {
  Flow flow = 1;
  EventType event_type = 2;
}

message ExportFlowResponse {
  string message = 1;
  bool received = 2;
  uint64 flows_processed = 3;
}

message StreamFlowsRequest {}

message StreamFlowsResponse {
  Flow flow = 1;
}

message Flow {
  oneof flow {
    HTTPFlow http_flow = 1;
    DNSFlow dns_flow = 2;
    TCPFlow tcp_flow = 3;
    UDPFlow udp_flow = 4;
  }
}

message TCPMessage {
  bytes content = 1;
  google.protobuf.Timestamp timestamp = 2;
  bool from_client = 3;
}

message TCPFlow {
  string id = 1 [(buf.validate.field).string.min_len = 1];
  ClientConn client = 2;
  ServerConn server = 3;
  repeated TCPMessage messages = 4;
  google.protobuf.Timestamp timestamp_start = 5;
  double duration_ms = 6;
  optional string error = 7;
  bool live = 8;
}

message UDPMessage {
  bytes content = 1;
  google.protobuf.Timestamp timestamp = 2;
  bool from_client = 3;
}

message UDPFlow {
  string id = 1 [(buf.validate.field).string.min_len = 1];
  ClientConn client = 2;
  ServerConn server = 3;
  repeated UDPMessage messages = 4;
  google.protobuf.Timestamp timestamp_start = 5;
  double duration_ms = 6;
  optional string error = 7;
  bool live = 8;
}

message WebSocketMessage {
  bytes content = 1;
  google.protobuf.Timestamp timestamp = 2;
  bool from_client = 3;
}

message DNSQuestion {
  string name = 1;
  string type = 2;
  string class = 3;
}

message DNSResourceRecord {
  string name = 1;
  string type = 2;
  string class = 3;
  uint32 ttl = 4;
  bytes data = 5;
}

message DNSMessage {
  bytes packed = 1;
  repeated DNSQuestion questions = 2;
  repeated DNSResourceRecord answers = 3;
  repeated DNSResourceRecord authorities = 4;
  repeated DNSResourceRecord additionals = 5;
  uint32 id = 6;
  bool query = 7;
  uint32 op_code = 8;
  bool authoritative_answer = 9;
}

message DNSFlow {
  string id = 1 [(buf.validate.field).string.min_len = 1];
  DNSMessage request = 2;
  optional DNSMessage response = 3;
  google.protobuf.Timestamp timestamp_start = 4;
  double duration_ms = 5;
  ClientConn client = 6;
  ServerConn server = 7;
  optional string error = 8;
  bool live = 9;
}

// The response message confirming receipt for streaming flows
message FlowStreamReply {
  string message = 1;
  bool received = 2;
  uint64 flows_processed = 3;
}

// A single HTTP Flow (Request/Response pair)
message HTTPFlow {
  string id = 1 [(buf.validate.field).string.min_len = 1];
  Request request = 2;
  Response response = 3;
  google.protobuf.Timestamp timestamp_start = 4;
  double duration_ms = 5;
  ClientConn client = 6;
  ServerConn server = 7;
  string error = 8;
  bool is_websocket = 9;
  bool live = 10;
  repeated WebSocketMessage websocket_messages = 11;
}

message Request {
  string method = 1 [
    (buf.validate.field).string.example = "GET",
    (buf.validate.field).string.example = "POST",
    (buf.validate.field).string.example = "PUT",
    (buf.validate.field).string.example = "DELETE",
    (buf.validate.field).string.example = "OPTIONS"
  ];
  string url = 2 [(buf.validate.field).string.uri = true];
  map<string, string> headers = 3 [
    (buf.validate.field).map.keys = {
      string: {
        example: "Content-Type"
        example: "User-Agent"
        example: "Accept"
        example: "Authorization"
        example: "Cookie"
      }
    },
    (buf.validate.field).map.values = {
      string: {
        example: "application/json"
        example: "application/proto"
        example: "text/html"
        example: "text/plain"
        example: "application/connect+proto"
      }
    }
  ];
  bytes content = 4;
  repeated string content_protoscope_frames = 5;
  string http_version = 6;
  map<string, string> trailers = 7;
  string effective_content_type = 8;
  google.protobuf.Timestamp timestamp_start = 9;
  google.protobuf.Timestamp timestamp_end = 10;
  string pretty_url = 11 [(buf.validate.field).string.uri = true];
  bool content_truncated = 12;
}

message Response {
  int32 status_code = 1 [(buf.validate.field).int32 = {
    gte: 100
    lte: 599
    example: 200
    example: 201
    example: 300
    example: 301
    example: 401
    example: 404
    example: 500
  }];
  map<string, string> headers = 2;
  bytes content = 3;
  repeated string content_protoscope_frames = 4;
  string http_version = 5;
  map<string, string> trailers = 6;
  string effective_content_type = 7;
  google.protobuf.Timestamp timestamp_start = 8;
  google.protobuf.Timestamp timestamp_end = 9;
  bool content_truncated = 10;
  string reason = 11;
}
