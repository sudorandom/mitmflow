edition = "2023";

package mitmflow.v1;

import "mitmproxygrpc/v1/service.proto";
import "buf/validate/validate.proto";

service Service {
  rpc StreamFlows(StreamFlowsRequest) returns (stream StreamFlowsResponse) {}
  rpc UpdateFlow(UpdateFlowRequest) returns (UpdateFlowResponse) {}
  rpc DeleteFlows(DeleteFlowsRequest) returns (DeleteFlowsResponse) {}
}

message StreamFlowsRequest {
  int64 since_timestamp_ns = 1;
  string filter_text = 2;
  bool pinned_only = 3;
  bool has_note = 4;
  repeated string flow_types = 5 [
    (buf.validate.field).repeated.items.string = {
      in: ["http", "dns", "tcp", "udp"]
    }
  ];
  repeated string client_ips = 6 [
    (buf.validate.field).repeated.items.string.ip = true
  ];
  HttpFilter http = 7;
  bool reverse_order = 8;
}

message HttpFilter {
  repeated string methods = 1 [
    (buf.validate.field).repeated.items.string = {
      pattern: "^[A-Z]+$",
      max_len: 20
    }
  ];
  // e.g. "application/json", "text/html"
  repeated string content_types = 2;
  // e.g. "200", "4xx", "200-299"
  repeated string status_codes = 3;
}

message StreamFlowsResponse {
  oneof response {
    Flow flow = 1;
    StreamEvent event = 2;
  }
}

message StreamEvent {
  enum Type {
    TYPE_UNSPECIFIED = 0;
    TYPE_HISTORY_DONE = 1;
  }
  Type type = 1;
}

message UpdateFlowRequest {
  string flow_id = 1;
  bool pinned = 2 [features.field_presence = EXPLICIT];
  string note = 3 [features.field_presence = EXPLICIT];
}

message UpdateFlowResponse {
  Flow flow = 1;
}

message DeleteFlowsRequest {
  repeated string flow_ids = 1;
  bool all = 2;
}

message DeleteFlowsResponse {
  int64 count = 1;
}

message Flow {
  oneof flow {
    mitmproxy.v1.HTTPFlow http_flow = 1;
    mitmproxy.v1.TCPFlow tcp_flow = 2;
    mitmproxy.v1.UDPFlow udp_flow = 3;
    mitmproxy.v1.DNSFlow dns_flow = 4;
  }
  HTTPFlowExtra http_flow_extra = 5;
  bool pinned = 6;
  string note = 7;
}

message HTTPFlowExtra {
  MessageDetails request = 1;
  MessageDetails response = 2;
}

message MessageDetails {
  repeated string textual_frames = 1;
  string effective_content_type = 2;
}
